@model LichCongTacWeb.Models.Schedule
@{
    Layout = "_Layout";
    bool isEdit = Model != null && Model.Id > 0;
}

<style>
    /* Hiệu ứng xoay mũi tên khi đóng/mở */
    .rotate-icon {
        transition: transform 0.3s ease;
        display: inline-block;
    }

    .btn-dept[aria-expanded="true"] .rotate-icon {
        transform: rotate(90deg);
    }
    /* Hover highlight cho dòng phòng ban */
    .dept-header:hover {
        background-color: #f8f9fa;
    }

    .dept-section {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        overflow: hidden;
    }

    /* Tăng trải nghiệm cho phần chọn thành phần phối hợp */
    .assignee-check:checked + .form-check-label {
        font-weight: bold;
        color: #dc3545;
    }
</style>

<div class="container mt-4 mb-5">
    <div class="card shadow">
        <div class="card-header bg-danger text-white">
            <h4 class="mb-0 text-center">@(isEdit ? "CẬP NHẬT LỊCH CÔNG TÁC" : "THÊM MỚI LỊCH CÔNG TÁC")</h4>
        </div>
        <div class="card-body p-4">
            <form asp-action="CreateSchedule" method="post" enctype="multipart/form-data" id="scheduleForm">
                @Html.AntiForgeryToken()
                @if (isEdit)
                {
                    <input type="hidden" asp-for="Id" />
                }

                <div class="row g-4">
                    @* 1. Đơn vị chủ trì *@
                    <div class="col-md-6">
                        <label class="form-label fw-bold"><i class="fa fa-building me-2"></i>1. Đơn vị chủ trì</label>
                        <select asp-for="DepartmentId" class="form-select" required id="mDeptId">
                            <option value="">-- Chọn đơn vị --</option>
                            @foreach (var d in ViewBag.Departments)
                            {
                                <option value="@d.Id">@d.Name</option>
                            }
                        </select>
                    </div>

                    @* 2. Người thực hiện chính *@
                    <div class="col-md-6">
                        <label class="form-label fw-bold"><i class="fa fa-user me-2"></i>2. Người thực hiện chính</label>
                        <select asp-for="LeaderId" class="form-select" required id="mLeaderId">
                            <option value="">-- Chọn cán bộ --</option>
                            @foreach (var l in ViewBag.AllLeaders)
                            {
                                <option value="@l.Id" data-dept="@l.DepartmentId">@l.FullName (@l.Position)</option>
                            }
                        </select>
                    </div>

                    @* 3. Ngày thực hiện *@
                    <div class="col-md-6">
                        <label class="form-label fw-bold"><i class="fa fa-calendar me-2"></i>3. Ngày thực hiện</label>
                        <input type="date" asp-for="WorkDate" class="form-control" required
                               value="@(Model?.WorkDate.ToString("yyyy-MM-dd") ?? DateTime.Now.ToString("yyyy-MM-dd"))" />
                    </div>

                    @* 4. Khung giờ *@
                    <div class="col-md-6">
                        <label class="form-label fw-bold"><i class="fa fa-clock me-2"></i>4. Khung giờ</label>
                        <div class="input-group">
                            <input type="text" asp-for="TimeSlot" id="timeSlotInput" class="form-control"
                                   placeholder="Gõ 'Sáng', 'Chiều' hoặc chọn giờ..." required />
                            <input type="time" id="timePicker" class="form-control" style="max-width: 45px; padding: 0; border-left: none; cursor: pointer;" title="Chọn giờ cụ thể" />
                        </div>
                    </div>

                    @* 5. Địa điểm *@
                    <div class="col-12">
                        <label class="form-label fw-bold"><i class="fa fa-map-marker-alt me-2"></i>5. Địa điểm</label>
                        <select class="form-select" id="locationSelect">
                            <option value="">-- Chọn địa điểm --</option>
                            @{
                                var defaultLocations = new[] { "Phòng họp tầng 1", "Phòng họp tầng 2", "Hội trường lớn", "Trực tuyến (Zoom/Meet)", "Tại đơn vị" };
                                bool isOtherLocation = isEdit && !string.IsNullOrEmpty(Model.Location) && !defaultLocations.Contains(Model.Location);
                            }
                            @foreach (var loc in defaultLocations)
                            {
                                <option value="@loc" selected="@(Model?.Location == loc ? "selected" : null)">@loc</option>
                            }
                            <option value="other" class="fw-bold text-primary" selected="@(isOtherLocation ? "selected" : null)">+ Nhập địa điểm khác...</option>
                        </select>
                        <div id="otherLocationWrapper" class="mt-2" style="display: @(isOtherLocation ? "block" : "none");">
                            <input type="text" id="otherLocationInput" class="form-control" placeholder="Gõ địa điểm cụ thể tại đây..." value="@(isOtherLocation ? Model.Location : "")" />
                        </div>
                        <input type="hidden" asp-for="Location" id="finalLocation" />
                    </div>

                    @* 6. Nội dung *@
                    <div class="col-12">
                        <label class="form-label fw-bold"><i class="fa fa-edit me-2"></i>6. Nội dung công việc</label>
                        <textarea asp-for="Content" class="form-control" rows="4" required placeholder="Nhập chi tiết nội dung công việc..."></textarea>
                    </div>

                    @* 7. File đính kèm *@
                    <div class="col-12">
                        <label class="form-label fw-bold text-success"><i class="fa fa-paperclip me-2"></i>7. Tài liệu đính kèm (PDF)</label>
                        <input type="file" name="AttachmentFiles" class="form-control" accept=".pdf" multiple>
                        @if (isEdit && !string.IsNullOrEmpty(Model.AttachmentPath))
                        {
                            <div class="mt-2 small text-muted">
                                <b>File hiện tại:</b> <span class="badge bg-light text-dark border">@Model.AttachmentPath</span>
                            </div>
                        }
                    </div>

                    @* 8. Thành phần phối hợp *@
                    <div class="col-12">
                        <label class="form-label fw-bold text-primary"><i class="fa fa-users me-2"></i>8. Thành phần phối hợp</label>
                        <div class="mb-2">
                            <textarea asp-for="AssigneeIds" id="AssigneeText" class="form-control" rows="3"
                                      placeholder="Nhập nội dung tự do hoặc chọn từ danh sách bên dưới..."></textarea>
                        </div>

                        <div class="border rounded p-3 bg-light" style="max-height: 450px; overflow-y: auto;">
                            @foreach (var dept in ViewBag.Departments)
                            {
                                <div class="dept-section mb-2 bg-white">
                                    <div class="d-flex align-items-center p-2 dept-header">
                                        <input class="form-check-input select-all-dept me-3" type="checkbox"
                                               id="dept_@dept.Id" data-dept-name="@dept.Name">
                                        <button class="btn btn-dept p-0 text-start flex-grow-1 text-dark fw-bold border-0 bg-transparent shadow-none"
                                                type="button" data-bs-toggle="collapse" data-bs-target="#collapse_@dept.Id">
                                            <i class="fa fa-chevron-right rotate-icon me-2 small text-muted"></i> @dept.Name
                                        </button>
                                    </div>
                                    <div class="collapse ms-4 border-top" id="collapse_@dept.Id">
                                        <div class="row p-3">
                                            @foreach (var leader in ((IEnumerable<dynamic>)ViewBag.AllLeaders).Where(l => l.DepartmentId == dept.Id))
                                            {
                                                <div class="col-md-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input assignee-check" type="checkbox"
                                                               value="@leader.FullName" id="chk_@leader.Id"
                                                               data-dept-id="dept_@dept.Id">
                                                        <label class="form-check-label" for="chk_@leader.Id">@leader.FullName</label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="mt-5 border-top pt-3 text-end">
                    <a href="@Url.Action("ManageSchedules")" class="btn btn-secondary px-4 me-2">
                        <i class="fa fa-arrow-left me-1"></i> Quay lại
                    </a>
                    <button type="submit" class="btn btn-danger px-5 fw-bold">
                        <i class="fa fa-save me-1"></i> LƯU LỊCH
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // --- XỬ LÝ ĐỔ DỮ LIỆU CŨ CHO MỤC 8 KHI EDIT ---
            var isEdit = @(isEdit.ToString().ToLower());
            var assigneeVal = $('#AssigneeText').val();

            if (isEdit && assigneeVal) {
                $('.assignee-check').each(function() {
                    var fullName = $(this).val();
                    if (assigneeVal.includes(fullName)) {
                        $(this).prop('checked', true);
                        var deptCollapse = $(this).closest('.collapse');
                        deptCollapse.addClass('show');

                        var deptId = $(this).data('dept-id');
                        // Kiểm tra nếu tất cả trong phòng đã được check thì check nút "Chọn tất cả" của phòng đó
                        var allInDept = $(`.assignee-check[data-dept-id="${deptId}"]`);
                        var checkedInDept = $(`.assignee-check[data-dept-id="${deptId}"]:checked`);
                        if(allInDept.length > 0 && allInDept.length === checkedInDept.length) {
                             $(`#${deptId}`).prop('checked', true);
                        }
                    }
                });

                // Kiểm tra xem có text "Tất cả [Phòng]" không để check nút đầu phòng
                $('.select-all-dept').each(function() {
                    var deptName = $(this).data('dept-name');
                    if(assigneeVal.includes("Tất cả " + deptName)) {
                        $(this).prop('checked', true);
                        var deptId = $(this).attr('id');
                        $(`.assignee-check[data-dept-id="${deptId}"]`).prop('checked', true);
                        $(`#collapse_${deptId.split('_')[1]}`).addClass('show');
                    }
                });
            }

            // --- LOGIC TƯƠNG TÁC MỤC 8 (THÀNH PHẦN PHỐI HỢP) ---
            var manualNote = "";

            // Lưu lại phần ghi chú thủ công khi người dùng gõ vào textarea
            $('#AssigneeText').on('input', function() {
                var currentVal = $(this).val();
                var tpIndex = currentVal.indexOf("TP: ");
                // Nếu tìm thấy "TP: ", phần trước nó là ghi chú thủ công
                manualNote = (tpIndex !== -1) ? currentVal.substring(0, tpIndex).trim() : currentVal.trim();
            });

            // Chọn tất cả cán bộ trong 1 đơn vị
            $('.select-all-dept').on('change', function() {
                var isChecked = $(this).is(':checked');
                var deptId = $(this).attr('id');
                $(`.assignee-check[data-dept-id="${deptId}"]`).prop('checked', isChecked);
                if(isChecked) $(`#collapse_${deptId.split('_')[1]}`).collapse('show');
                updateAssigneeText();
            });

            // Chọn lẻ từng cán bộ
            $('.assignee-check').on('change', function() {
                var deptId = $(this).data('dept-id');
                var allInDept = $(`.assignee-check[data-dept-id="${deptId}"]`);
                var checkedInDept = $(`.assignee-check[data-dept-id="${deptId}"]:checked`);
                // Tự động check/uncheck nút "Chọn tất cả" của phòng
                $(`#${deptId}`).prop('checked', allInDept.length === checkedInDept.length);
                updateAssigneeText();
            });

            function updateAssigneeText() {
                var selectedEntries = [];
                $('.select-all-dept').each(function() {
                    var deptName = $(this).data('dept-name');
                    var deptId = $(this).attr('id');
                    var childrenChecked = $(`.assignee-check[data-dept-id="${deptId}"]:checked`);

                    if ($(this).is(':checked')) {
                        selectedEntries.push("Tất cả " + deptName);
                    } else if (childrenChecked.length > 0) {
                        childrenChecked.each(function() {
                            selectedEntries.push($(this).val());
                        });
                    }
                });

                var finalText = manualNote;
                if (selectedEntries.length > 0) {
                    if (finalText !== "") finalText += " ";
                    finalText += "TP: " + selectedEntries.join(", ");
                }
                $('#AssigneeText').val(finalText);
            }

            // --- XỬ LÝ KHUNG GIỜ ---
            $('#timePicker').on('input', function() {
                var val = $(this).val();
                if (!val) return;
                var hour = parseInt(val.split(':')[0]);
                var prefix = hour < 12 ? "Sáng" : (hour < 18 ? "Chiều" : "Tối");
                $('#timeSlotInput').val(prefix + " " + val);
            });

            // --- XỬ LÝ ĐỊA ĐIỂM ---
            $('#locationSelect').on('change', function() {
                var val = $(this).val();
                if (val === 'other') {
                    $('#otherLocationWrapper').show();
                    $('#otherLocationInput').prop('required', true).focus();
                    $('#finalLocation').val($('#otherLocationInput').val());
                } else {
                    $('#otherLocationWrapper').hide();
                    $('#otherLocationInput').prop('required', false);
                    $('#finalLocation').val(val);
                }
            });

            $('#otherLocationInput').on('input', function() {
                $('#finalLocation').val($(this).val());
            });

            // Khởi tạo giá trị địa điểm ban đầu
            if($('#locationSelect').val() === 'other'){
                $('#finalLocation').val($('#otherLocationInput').val());
            } else {
                $('#finalLocation').val($('#locationSelect').val());
            }

            // --- LỌC CÁN BỘ THEO ĐƠN VỊ ---
            $('#mDeptId').on('change', function() {
                var deptId = $(this).val();
                $('#mLeaderId').val(""); // Reset chọn cán bộ khi đổi đơn vị
                $('#mLeaderId option').each(function() {
                    const optDeptId = $(this).data('dept');
                    if (deptId === "" || optDeptId == deptId || $(this).val() === "") {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // Trigger lọc ban đầu nếu là trang Edit
            if(isEdit) {
                $('#mDeptId').trigger('change');
                // Giữ lại đúng leader đã chọn
                $('#mLeaderId').val('@(Model?.LeaderId)');
            }
        });
    </script>
}
