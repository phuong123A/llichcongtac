@using LichCongTacWeb.Models
@model IEnumerable<Leader>
@{
    var departments = ViewBag.Departments as List<Department> ?? new List<Department>();
    var locations = ViewBag.Locations as List<Location> ?? new List<Location>();
    Layout = "_Layout";
    ViewData["Title"] = "Quản trị hệ thống";
}

<style>
    :root {
        --lc-red: #d32f2f;
        --lc-dark: #b71c1c;
        --lc-light-red: #fff5f5;
        --border-color: #f1f1f1;
    }

    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Arial, sans-serif;
    }

    /* Tiêu đề chính */
    .admin-top-header {
        background: var(--lc-red);
        color: white;
        padding: 25px 0;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

        .admin-top-header h2 {
            font-weight: 800;
            text-transform: uppercase;
            margin: 0;
            letter-spacing: 1px;
        }

    /* Khung điều khiển tổng (Main Control Box) */
    .control-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 1px solid #eee;
        overflow: hidden;
        margin-bottom: 25px;
        display: flex;
        min-height: 70vh;
    }

    /* Cột trái: Đơn vị & Địa điểm */
    .side-control {
        width: 300px;
        background: #fdfdfd;
        border-right: 1px solid #eee;
        padding: 20px;
    }

    .side-title {
        color: var(--lc-red);
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    .side-btn-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .btn-side {
        width: 100%;
        text-align: left;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        font-weight: 600;
        color: #444;
        transition: all 0.2s;
    }

        .btn-side:hover {
            background: var(--lc-light-red);
            border-color: var(--lc-red);
            color: var(--lc-red);
        }

        .btn-side i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

    /* Cột phải: Lọc và bảng */
    .main-content-area {
        flex: 1;
        padding: 20px;
    }

    .filter-action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--lc-light-red);
        margin-bottom: 20px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        gap: 10px;
        flex: 1;
        min-width: 300px;
    }

    .form-select-red {
        border-color: #ddd;
        font-weight: 500;
        height: 45px;
    }

        .form-select-red:focus {
            border-color: var(--lc-red);
            box-shadow: 0 0 0 0.25rem rgba(211, 47, 47, 0.1);
        }

    .btn-add-red {
        background: var(--lc-red);
        color: white;
        border: none;
        padding: 0 25px;
        height: 45px;
        border-radius: 6px;
        font-weight: 700;
        white-space: nowrap;
        transition: 0.3s;
    }

        .btn-add-red:hover {
            background: var(--lc-dark);
            color: white;
            transform: translateY(-2px);
        }

    /* Bảng dữ liệu đỏ */
    .table-red thead th {
        background-color: var(--lc-red) !important;
        color: white !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 15px;
        border: none;
    }

    .table-red tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid #eee;
    }

    .leader-row:hover {
        background-color: var(--lc-light-red) !important;
    }

    .badge-red {
        background: var(--lc-light-red);
        color: var(--lc-red);
        border: 1px solid var(--lc-red);
        padding: 5px 12px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .action-icons .btn {
        width: 35px;
        height: 35px;
        padding: 0;
        line-height: 35px;
        border-radius: 4px;
        margin: 0 2px;
    }

    /* Modal Styling */
    .modal-header-red {
        background: var(--lc-red);
        color: white;
    }

    @@media(max - width: 992px) {
            .control-wrapper {
                flex-direction: column;
            }

            .side-control {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>

    <div class="admin-top-header">
        <div class="container-fluid">
            <h2>Hệ thống Quản trị nhân sự</h2>
        </div>
    </div>

    <div class="container-fluid px-4">
        <div class="control-wrapper">
            <div class="side-control">
                <div class="side-title">
                    <i class="fa fa-cog me-2"></i> Cấu hình hệ thống
                </div>
                <div class="side-btn-group">
                    <button class="btn-side" onclick="$('#deptModal').modal('show')">
                        <i class="fa fa-sitemap text-primary"></i> Quản lý Đơn vị
                    </button>
                    <button class="btn-side" onclick="$('#locationModal').modal('show')">
                        <i class="fa fa-map-marker-alt text-danger"></i> Quản lý Địa điểm
                    </button>
                </div>

                <hr class="my-4 opacity-50">
                <div class="text-muted small">
                    <p><i class="fa fa-info-circle me-1"></i> <strong>Lưu ý:</strong> Nên cập nhật danh sách Đơn vị và Địa điểm trước khi khởi tạo tài khoản cán bộ để đảm bảo dữ liệu đồng bộ.</p>
                </div>
            </div>

            <div class="main-content-area">
                <div class="filter-action-bar">
                    <div class="filter-group">
                        <select id="filterDept" class="form-select form-select-red" onchange="handleDeptChange()">
                            <option value="">-- Tất cả đơn vị --</option>
                            @foreach (var d in departments)
                            {
                                <option value="@d.Name">@d.Name</option>
                            }
                        </select>

                        <select id="filterLeader" class="form-select form-select-red" onchange="applyFilters()">
                            <option value="">-- Chọn cán bộ --</option>
                            @foreach (var item in Model.OrderBy(x => x.DisplayOrder))
                            {
                                <option value="@item.FullName" data-dept="@(item.Department?.Name ?? "")">@item.FullName</option>
                            }
                        </select>

                        <button class="btn btn-outline-secondary" onclick="resetFilters()" title="Làm mới bộ lọc">
                            <i class="fa fa-sync-alt"></i>
                        </button>
                    </div>

                    <button class="btn-add-red" onclick="openLeaderModal(this)" data-id="0">
                        <i class="fa fa-plus-circle me-2"></i>THÊM MỚI CÁN BỘ
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-red" id="leaderTable">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 50px;">STT</th>
                                <th>Thông tin cán bộ</th>
                                <th>Tài khoản</th>
                                <th>Đơn vị</th>
                                <th class="text-center">Vai trò</th>
                                <th class="text-center">Thứ tự</th>
                                <th class="text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int stt = 1;
                            }
                            @foreach (var item in Model.OrderBy(x => x.DisplayOrder))
                            {
                                <tr class="leader-row">
                                    <td class="text-center fw-bold text-muted">@stt</td>
                                    <td class="col-fullname">
                                        <div class="fw-bold">@item.FullName</div>
                                        <div class="small text-muted">@item.Position</div>
                                    </td>
                                    <td><code class="text-danger fw-bold">@item.Username</code></td>
                                    <td class="col-deptname">
                                        <i class="fa fa-building text-muted me-1 small"></i> @(item.Department?.Name ?? "---")
                                    </td>
                                    <td class="text-center">
                                        @if (item.RoleId == 1)
                                        {
                                            <span class="badge bg-dark">Admin</span>
                                        }
                                        else if (item.RoleId == 4)
                                        {
                                            <span class="badge bg-warning text-dark">Thư ký</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-red">Lãnh đạo</span>
                                        }
                                    </td>
                                    <td class="text-center">@item.DisplayOrder</td>
                                    <td class="text-center action-icons">
                                        <button class="btn btn-sm btn-outline-primary" onclick="openLeaderModal(this)"
                                                data-id="@item.Id" data-name="@item.FullName" data-user="@item.Username"
                                                data-pos="@item.Position" data-dept="@item.DepartmentId"
                                                data-role="@item.RoleId" data-order="@item.DisplayOrder" title="Sửa">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLeader('@item.Id')" title="Xóa">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                stt++;
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header modal-header-red">
                    <h5 class="modal-title fw-bold">DANH SÁCH ĐỊA ĐIỂM</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="input-group mb-3">
                        <input type="text" id="newLocName" class="form-control" placeholder="Tên địa điểm mới...">
                        <button class="btn btn-success" onclick="addLocation()"><i class="fa fa-plus"></i></button>
                    </div>
                    <div class="list-group border" style="max-height: 300px; overflow-y:auto">
                        @foreach (var loc in locations)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>@loc.Name</span>
                                <button class="btn btn-link text-danger p-0" onclick="deleteLocation(@loc.Id)"><i class="fa fa-trash-alt"></i></button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deptModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header modal-header-red">
                    <h5 class="modal-title fw-bold">DANH SÁCH ĐƠN VỊ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="input-group mb-3">
                        <input type="text" id="newDeptName" class="form-control" placeholder="Tên đơn vị mới...">
                        <button class="btn btn-success" onclick="addDept()"><i class="fa fa-plus"></i></button>
                    </div>
                    <div class="list-group border" style="max-height: 300px; overflow-y:auto">
                        @foreach (var d in departments)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>@d.Name</span>
                                <button class="btn btn-link text-danger p-0" onclick="deleteDept(@d.Id)"><i class="fa fa-trash-alt"></i></button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="leaderModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <form id="leaderForm" class="modal-content border-0">
                <div class="modal-header modal-header-red">
                    <h5 class="modal-title fw-bold" id="modalTitle">THÔNG TIN CÁN BỘ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Id" id="f_id" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Họ và tên *</label>
                            <input type="text" name="FullName" id="f_name" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Thứ tự hiển thị</label>
                            <input type="number" name="DisplayOrder" id="f_order" class="form-control" value="0" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tên đăng nhập *</label>
                            <input type="text" name="Username" id="f_user" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Mật khẩu</label>
                            <input type="password" name="Password" id="f_pass" class="form-control" placeholder="Để trống nếu không đổi (Mặc định: 123456)" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Đơn vị</label>
                            <select name="DepartmentId" id="f_dept" class="form-select">
                                <option value="">-- Chọn đơn vị --</option>
                                @foreach (var d in departments)
                                {
                                    <option value="@d.Id">@d.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Chức vụ</label>
                            <input type="text" name="Position" id="f_pos" class="form-control" />
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Vai trò hệ thống</label>
                            <select name="RoleId" id="f_role" class="form-select border-primary fw-bold">
                                <option value="5">Lãnh đạo (Xem lịch)</option>
                                <option value="4">Thư ký (Nhập lịch)</option>
                                <option value="1">Admin (Quản trị toàn quyền)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-danger px-5 fw-bold">LƯU DỮ LIỆU</button>
                </div>
            </form>
        </div>
    </div>

    @section Scripts {
        <script>
            // --- LOGIC LỌC DỮ LIỆU ---
            function handleDeptChange() {
                var selectedDept = $('#filterDept').val().toLowerCase().trim();
                $('#filterLeader').val("");
                $('#filterLeader option').each(function() {
                    var leaderDept = $(this).data('dept') ? $(this).data('dept').toString().toLowerCase().trim() : "";
                    if (selectedDept === "" || leaderDept === selectedDept || $(this).val() === "") {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
                applyFilters();
            }

            function applyFilters() {
                var selectedDept = $('#filterDept').val().toLowerCase().trim();
                var selectedLeader = $('#filterLeader').val().toLowerCase().trim();
                $('.leader-row').each(function() {
                    var rowDept = $(this).find('.col-deptname').text().toLowerCase().trim();
                    var rowName = $(this).find('.col-fullname .fw-bold').text().toLowerCase().trim();

                    var matchDept = selectedDept === "" || rowDept.indexOf(selectedDept) > -1;
                    var matchLeader = selectedLeader === "" || rowName.indexOf(selectedLeader) > -1;

                    $(this).toggle(matchDept && matchLeader);
                });
            }

            function resetFilters() {
                $('#filterDept, #filterLeader').val("");
                $('#filterLeader option').show();
                $('.leader-row').show();
            }

            // --- AJAX QUẢN LÝ ĐỊA ĐIỂM ---
            function addLocation() {
                var name = $('#newLocName').val();
                if (!name) return alert("Vui lòng nhập tên địa điểm");
                $.post('@Url.Action("SaveLocation", "Admin")', { id: 0, name: name }, function(res) {
                    if (res.success) location.reload(); else alert(res.message || "Lỗi khi lưu");
                });
            }

            function deleteLocation(id) {
                if (confirm("Xóa địa điểm này?")) {
                    $.post('@Url.Action("DeleteLocation", "Admin")', { id: id }, function(res) {
                        if (res.success) location.reload(); else alert(res.message || "Không thể xóa");
                    });
                }
            }

            // --- AJAX QUẢN LÝ ĐƠN VỊ ---
            function addDept() {
                var name = $('#newDeptName').val();
                if (!name) return alert("Vui lòng nhập tên đơn vị");
                $.post('@Url.Action("SaveDepartment", "Admin")', { id: 0, name: name }, function(res) {
                    if (res.success) location.reload(); else alert(res.message || "Lỗi khi lưu");
                });
            }

            function deleteDept(id) {
                if (confirm("Xóa đơn vị này? Cán bộ thuộc đơn vị này sẽ bị mất thông tin đơn vị.")) {
                    $.post('@Url.Action("DeleteDepartment", "Admin")', { id: id }, function(res) {
                        if (res.success) location.reload(); else alert(res.message || "Không thể xóa (Đơn vị có thể đang có cán bộ)");
                    });
                }
            }

            // --- AJAX QUẢN LÝ CÁN BỘ ---
            function openLeaderModal(btn) {
                const d = btn.dataset;
                document.getElementById('leaderForm').reset();

                // Cập nhật tiêu đề modal
                if(d.id === "0") {
                    $('#modalTitle').text("THÊM MỚI CÁN BỘ");
                    $('#f_user').prop('readonly', false);
                } else {
                    $('#modalTitle').text("CHỈNH SỬA THÔNG TIN: " + d.name);
                    $('#f_user').prop('readonly', true);
                }

                $('#f_id').val(d.id || "0");
                $('#f_name').val(d.name || "");
                $('#f_user').val(d.user || "");
                $('#f_pos').val(d.pos || "");
                $('#f_dept').val(d.dept || "");
                $('#f_role').val(d.role || "5");
                $('#f_order').val(d.order || "0");
                $('#f_pass').val(""); // Luôn để trống mật khẩu khi mở modal

                $('#leaderModal').modal('show');
            }

            $('#leaderForm').on('submit', function(e) {
                e.preventDefault();
                var formData = $(this).serialize();
                $.post('@Url.Action("SaveLeader", "Admin")', formData, function(res) {
                    if (res.success) {
                        location.reload();
                    } else {
                        alert(res.message || "Lỗi khi lưu dữ liệu cán bộ");
                    }
                });
            });

            function deleteLeader(id) {
                if (confirm('Bạn có chắc chắn muốn xóa vĩnh viễn tài khoản này? Thao tác không thể hoàn tác.')) {
                    $.post('@Url.Action("DeleteLeader", "Admin")', { id: id }, function(res) {
                        if (res.success) location.reload(); else alert(res.message || "Lỗi khi xóa");
                    });
                }
            }
        </script>
    }